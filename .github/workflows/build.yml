name: Build Kotokely APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Java
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    # 3. Setup Flutter
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    # 4. Verify Flutter installation
    - name: âœ… Verify Flutter
      run: |
        flutter --version
        flutter doctor -v
    
    # 5. Get dependencies
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    # 5.5. Generate/Verify Android project structure
    - name: ğŸ—ï¸ Generate Android Project Files
      run: |
        echo "Checking Android project structure..."
        
        if [ ! -d "android" ] || [ ! -f "android/app/src/main/AndroidManifest.xml" ]; then
          echo "âš ï¸ Android project incomplete or missing"
          echo "ğŸ”§ Generating Android platform files..."
          
          # Create Android platform
          flutter create --platforms=android --org=com.kotokely --project-name=kotokely_ai .
          
          echo "âœ… Android project structure created"
        else
          echo "âœ… Android project already exists"
        fi
        
        # Verify critical files
        echo ""
        echo "ğŸ“‹ Verifying Android files:"
        [ -f "android/app/src/main/AndroidManifest.xml" ] && echo "  âœ“ AndroidManifest.xml" || echo "  âœ— AndroidManifest.xml"
        [ -f "android/app/build.gradle" ] && echo "  âœ“ build.gradle" || echo "  âœ— build.gradle"
        [ -f "android/build.gradle" ] && echo "  âœ“ root build.gradle" || echo "  âœ— root build.gradle"
        [ -d "android/app/src/main/res" ] && echo "  âœ“ res directory" || echo "  âœ— res directory"
    
    # 6. Configure Android project
    - name: âš™ï¸ Configure Android Project
      run: |
        echo "Configuring Android project for Kotokely AI..."
        
        # Update AndroidManifest.xml with app name and permissions
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
          # Backup original
          cp android/app/src/main/AndroidManifest.xml android/app/src/main/AndroidManifest.xml.bak
          
          # Add/Update app label
          sed -i 's/android:label="[^"]*"/android:label="Kotokely AI"/g' android/app/src/main/AndroidManifest.xml
          
          # Add internet permission if not exists
          if ! grep -q "android.permission.INTERNET" android/app/src/main/AndroidManifest.xml; then
            sed -i '/<manifest/a\    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          fi
          
          # Add camera permission if not exists
          if ! grep -q "android.permission.CAMERA" android/app/src/main/AndroidManifest.xml; then
            sed -i '/<uses-permission android:name="android.permission.INTERNET"/a\    <uses-permission android:name="android.permission.CAMERA" />' android/app/src/main/AndroidManifest.xml
          fi
          
          # Add storage permissions if not exists
          if ! grep -q "android.permission.READ_EXTERNAL_STORAGE" android/app/src/main/AndroidManifest.xml; then
            sed -i '/<uses-permission android:name="android.permission.CAMERA"/a\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' android/app/src/main/AndroidManifest.xml
          fi
          
          echo "âœ… AndroidManifest.xml configured"
          echo ""
          echo "ğŸ“„ AndroidManifest.xml content:"
          cat android/app/src/main/AndroidManifest.xml
        fi
    
    # 7. Generate Android icons
    - name: ğŸ¨ Generate Android Icons
      run: |
        if [ -f "assets/icon/icon.png" ]; then
          echo "ğŸ“± Icon found at: assets/icon/icon.png"
          
          # Check if flutter_launcher_icons is in dependencies
          if grep -q "flutter_launcher_icons" pubspec.yaml; then
            echo "ğŸ¨ Generating launcher icons..."
            flutter pub run flutter_launcher_icons || {
              echo "âš ï¸ Icon generation failed, but continuing..."
              exit 0
            }
          else
            echo "âš ï¸ flutter_launcher_icons not found in pubspec.yaml"
            echo "ğŸ’¡ To add icon generation, add this to pubspec.yaml:"
            echo ""
            echo "dev_dependencies:"
            echo "  flutter_launcher_icons: ^0.13.1"
            echo ""
            echo "flutter_launcher_icons:"
            echo "  android: true"
            echo "  ios: false"
            echo "  image_path: \"assets/icon/icon.png\""
          fi
        else
          echo "âš ï¸ Icon not found at assets/icon/icon.png"
          echo "Skipping icon generation..."
        fi
      continue-on-error: true
    
    # 8. Build APK (Split per ABI)
    - name: ğŸ”¨ Build APK (Split per ABI)
      run: |
        echo "ğŸ”¨ Building split APKs..."
        flutter build apk --release --split-per-abi
        
    # 9. Build Universal APK
    - name: ğŸ”¨ Build Universal APK
      run: |
        echo "ğŸ”¨ Building universal APK..."
        flutter build apk --release
        
    # 10. Rename and organize APKs
    - name: ğŸ“ Rename APKs
      run: |
        cd build/app/outputs/flutter-apk
        
        echo "ğŸ“¦ Organizing APK files..."
        
        # Rename split APKs
        [ -f app-armeabi-v7a-release.apk ] && mv app-armeabi-v7a-release.apk kotokely-arm32.apk && echo "  âœ“ kotokely-arm32.apk"
        [ -f app-arm64-v8a-release.apk ] && mv app-arm64-v8a-release.apk kotokely-arm64.apk && echo "  âœ“ kotokely-arm64.apk"
        [ -f app-x86_64-release.apk ] && mv app-x86_64-release.apk kotokely-x86_64.apk && echo "  âœ“ kotokely-x86_64.apk"
        [ -f app-release.apk ] && mv app-release.apk kotokely-universal.apk && echo "  âœ“ kotokely-universal.apk"
        
        echo ""
        echo "ğŸ“Š Final APK sizes:"
        ls -lh kotokely-*.apk 2>/dev/null || ls -lh *.apk
    
    # 11. Get version from pubspec.yaml
    - name: ğŸ“Œ Get version
      id: version
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ Version: $VERSION"
    
    # 12. Upload ARM32 APK
    - name: ğŸ“¤ Upload ARM32 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-arm32-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-arm32.apk
        if-no-files-found: warn
    
    # 13. Upload ARM64 APK
    - name: ğŸ“¤ Upload ARM64 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-arm64-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-arm64.apk
    
    # 14. Upload x86_64 APK
    - name: ğŸ“¤ Upload x86_64 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-x86_64-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-x86_64.apk
        if-no-files-found: warn
    
    # 15. Upload Universal APK
    - name: ğŸ“¤ Upload Universal APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-universal-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-universal.apk
    
    # 16. Create Release (only on tag)
    - name: ğŸš€ Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/app/outputs/flutter-apk/kotokely-arm32.apk
          build/app/outputs/flutter-apk/kotokely-arm64.apk
          build/app/outputs/flutter-apk/kotokely-x86_64.apk
          build/app/outputs/flutter-apk/kotokely-universal.apk
        name: Kotokely AI v${{ steps.version.outputs.version }}
        body: |
          ## ğŸ¦ Kotokely AI v${{ steps.version.outputs.version }}
          
          ### ğŸ“¥ Downloads:
          - **kotokely-universal.apk** - Ho an'ny telefaona rehetra (lehibe kokoa)
          - **kotokely-arm64.apk** - Ho an'ny telefaona maoderina (64-bit) - â­ Recommended
          - **kotokely-arm32.apk** - Ho an'ny telefaona taloha (32-bit)
          - **kotokely-x86_64.apk** - Ho an'ny emulators
          
          ### âœ¨ Features:
          - ğŸ’¬ Kotokely - Text Chat & File Upload
          - ğŸ¨ Balita - Image Generation
          - ğŸ¬ Ketaka - Video Generation
          
          ### ğŸ“± Installation:
          1. Download ny APK mifanaraka amin'ny telefaonao
          2. Enable "Install from Unknown Sources" ao amin'ny Settings
          3. Install ny APK
          4. Enjoy! ğŸ‰
          
          Built with â¤ï¸ by Kotokely AI Team
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}