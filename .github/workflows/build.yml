name: Build Kotokely APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Java
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    # 3. Setup Flutter
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    # 4. Verify Flutter installation
    - name: âœ… Verify Flutter
      run: |
        flutter --version
        flutter doctor -v
    
    # 5. Get dependencies
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    # 5.5. Generate/Verify Android project structure
    - name: ğŸ—ï¸ Generate Android Project Files
      run: |
        echo "Checking Android project structure..."
        
        if [ ! -d "android" ] || [ ! -f "android/app/src/main/AndroidManifest.xml" ]; then
          echo "âš ï¸ Android project incomplete or missing"
          echo "ğŸ”§ Generating Android platform files..."
          
          # Create Android platform
          flutter create --platforms=android --org=com.kotokely --project-name=kotokely_ai .
          
          echo "âœ… Android project structure created"
        else
          echo "âœ… Android project already exists"
        fi
        
        # Verify critical files
        echo ""
        echo "ğŸ“‹ Verifying Android files:"
        [ -f "android/app/src/main/AndroidManifest.xml" ] && echo "  âœ“ AndroidManifest.xml" || echo "  âœ— AndroidManifest.xml"
        [ -f "android/app/build.gradle" ] && echo "  âœ“ app/build.gradle" || echo "  âœ— app/build.gradle"
        [ -f "android/build.gradle" ] && echo "  âœ“ root build.gradle" || echo "  âœ— root build.gradle"
        [ -d "android/app/src/main/res" ] && echo "  âœ“ res directory" || echo "  âœ— res directory"
    
    # 6. Configure Android Gradle files
    - name: âš™ï¸ Configure Android Build Files
      run: |
        echo "ğŸ”§ Configuring Android build files..."
        
        # Configure android/app/build.gradle
        if [ -f "android/app/build.gradle" ]; then
          echo "Updating android/app/build.gradle..."
          
          cat > android/app/build.gradle << 'EOF'
plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

android {
    namespace = "com.kotokely.kotokely_ai"
    compileSdk = flutter.compileSdkVersion
    ndkVersion = flutter.ndkVersion

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_1_8
    }

    defaultConfig {
        applicationId = "com.kotokely.kotokely_ai"
        minSdk = flutter.minSdkVersion
        targetSdk = flutter.targetSdkVersion
        versionCode = flutter.versionCode
        versionName = flutter.versionName
    }

    buildTypes {
        release {
            signingConfig = signingConfigs.debug
        }
    }
}

flutter {
    source = "../.."
}

dependencies {}
EOF
          
          echo "âœ… app/build.gradle configured"
        fi
        
        # Configure android/build.gradle
        if [ -f "android/build.gradle" ]; then
          echo "Updating android/build.gradle..."
          
          cat > android/build.gradle << 'EOF'
buildscript {
    ext.kotlin_version = '1.9.10'
    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath "com.android.tools.build:gradle:7.4.2"
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.buildDir = "../build"
subprojects {
    project.buildDir = "${rootProject.buildDir}/${project.name}"
}
subprojects {
    project.evaluationDependsOn(":app")
}

tasks.register("clean", Delete) {
    delete rootProject.buildDir
}
EOF
          
          echo "âœ… root build.gradle configured"
        fi
        
        # Configure android/settings.gradle
        if [ -f "android/settings.gradle" ]; then
          echo "Updating android/settings.gradle..."
          
          cat > android/settings.gradle << 'EOF'
pluginManagement {
    def flutterSdkPath = {
        def properties = new Properties()
        file("local.properties").withInputStream { properties.load(it) }
        def flutterSdkPath = properties.getProperty("flutter.sdk")
        assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
        return flutterSdkPath
    }()

    includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "dev.flutter.flutter-plugin-loader" version "1.0.0"
    id "com.android.application" version "7.4.2" apply false
    id "org.jetbrains.kotlin.android" version "1.9.10" apply false
}

include ":app"
EOF
          
          echo "âœ… settings.gradle configured"
        fi
        
        # Configure gradle.properties
        if [ -f "android/gradle.properties" ]; then
          echo "Updating android/gradle.properties..."
          
          cat > android/gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=2G -XX:+HeapDumpOnOutOfMemoryError
android.useAndroidX=true
android.enableJetifier=true
android.defaults.buildfeatures.buildconfig=true
android.nonTransitiveRClass=false
android.nonFinalResIds=false
EOF
          
          echo "âœ… gradle.properties configured"
        fi
        
        echo ""
        echo "âœ… All Android build files configured!"
    
    # 7. Configure AndroidManifest.xml
    - name: âš™ï¸ Configure AndroidManifest
      run: |
        echo "Configuring AndroidManifest.xml for Kotokely AI..."
        
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
          # Backup original
          cp android/app/src/main/AndroidManifest.xml android/app/src/main/AndroidManifest.xml.bak
          
          # Create new AndroidManifest with all necessary permissions
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- Permissions -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
                     android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    
    <application
        android:label="Kotokely AI"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    
    <queries>
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="https" />
        </intent>
    </queries>
</manifest>
EOF
          
          echo "âœ… AndroidManifest.xml configured"
          echo ""
          echo "ğŸ“„ AndroidManifest.xml content:"
          cat android/app/src/main/AndroidManifest.xml
        fi
    
    # 8. Generate Android icons
    - name: ğŸ¨ Generate Android Icons
      run: |
        if [ -f "assets/icon/icon.png" ]; then
          echo "ğŸ“± Icon found at: assets/icon/icon.png"
          
          # Check if flutter_launcher_icons is in dependencies
          if grep -q "flutter_launcher_icons" pubspec.yaml; then
            echo "ğŸ¨ Generating launcher icons..."
            flutter pub run flutter_launcher_icons || {
              echo "âš ï¸ Icon generation failed, but continuing..."
              exit 0
            }
          else
            echo "âš ï¸ flutter_launcher_icons not found in pubspec.yaml"
            echo "ğŸ’¡ To add icon generation, add this to pubspec.yaml:"
            echo ""
            echo "dev_dependencies:"
            echo "  flutter_launcher_icons: ^0.13.1"
            echo ""
            echo "flutter_launcher_icons:"
            echo "  android: true"
            echo "  ios: false"
            echo "  image_path: \"assets/icon/icon.png\""
          fi
        else
          echo "âš ï¸ Icon not found at assets/icon/icon.png"
          echo "Skipping icon generation..."
        fi
      continue-on-error: true
    
    # 9. Clean build
    - name: ğŸ§¹ Clean build
      run: |
        flutter clean
        flutter pub get
    
    # 10. Build APK (Split per ABI)
    - name: ğŸ”¨ Build APK (Split per ABI)
      run: |
        echo "ğŸ”¨ Building split APKs..."
        flutter build apk --release --split-per-abi
        
    # 11. Build Universal APK
    - name: ğŸ”¨ Build Universal APK
      run: |
        echo "ğŸ”¨ Building universal APK..."
        flutter build apk --release
        
    # 12. Rename and organize APKs
    - name: ğŸ“ Rename APKs
      run: |
        cd build/app/outputs/flutter-apk
        
        echo "ğŸ“¦ Organizing APK files..."
        
        # Rename split APKs
        [ -f app-armeabi-v7a-release.apk ] && mv app-armeabi-v7a-release.apk kotokely-arm32.apk && echo "  âœ“ kotokely-arm32.apk"
        [ -f app-arm64-v8a-release.apk ] && mv app-arm64-v8a-release.apk kotokely-arm64.apk && echo "  âœ“ kotokely-arm64.apk"
        [ -f app-x86_64-release.apk ] && mv app-x86_64-release.apk kotokely-x86_64.apk && echo "  âœ“ kotokely-x86_64.apk"
        [ -f app-release.apk ] && mv app-release.apk kotokely-universal.apk && echo "  âœ“ kotokely-universal.apk"
        
        echo ""
        echo "ğŸ“Š Final APK sizes:"
        ls -lh kotokely-*.apk 2>/dev/null || ls -lh *.apk
    
    # 13. Get version from pubspec.yaml
    - name: ğŸ“Œ Get version
      id: version
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ Version: $VERSION"
    
    # 14. Upload ARM32 APK
    - name: ğŸ“¤ Upload ARM32 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-arm32-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-arm32.apk
        if-no-files-found: warn
    
    # 15. Upload ARM64 APK
    - name: ğŸ“¤ Upload ARM64 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-arm64-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-arm64.apk
    
    # 16. Upload x86_64 APK
    - name: ğŸ“¤ Upload x86_64 APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-x86_64-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-x86_64.apk
        if-no-files-found: warn
    
    # 17. Upload Universal APK
    - name: ğŸ“¤ Upload Universal APK
      uses: actions/upload-artifact@v4
      with:
        name: kotokely-universal-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/kotokely-universal.apk
    
    # 18. Create Release (only on tag)
    - name: ğŸš€ Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/app/outputs/flutter-apk/kotokely-arm32.apk
          build/app/outputs/flutter-apk/kotokely-arm64.apk
          build/app/outputs/flutter-apk/kotokely-x86_64.apk
          build/app/outputs/flutter-apk/kotokely-universal.apk
        name: Kotokely AI v${{ steps.version.outputs.version }}
        body: |
          ## ğŸ¦ Kotokely AI v${{ steps.version.outputs.version }}
          
          ### ğŸ“¥ Downloads:
          - **kotokely-universal.apk** - Ho an'ny telefaona rehetra (lehibe kokoa)
          - **kotokely-arm64.apk** - Ho an'ny telefaona maoderina (64-bit) - â­ Recommended
          - **kotokely-arm32.apk** - Ho an'ny telefaona taloha (32-bit)
          - **kotokely-x86_64.apk** - Ho an'ny emulators
          
          ### âœ¨ Features:
          - ğŸ’¬ Kotokely - Text Chat & File Upload
          - ğŸ¨ Balita - Image Generation
          - ğŸ¬ Ketaka - Video Generation
          
          ### ğŸ“± Installation:
          1. Download ny APK mifanaraka amin'ny telefaonao
          2. Enable "Install from Unknown Sources" ao amin'ny Settings
          3. Install ny APK
          4. Enjoy! ğŸ‰
          
          Built with â¤ï¸ by Kotokely AI Team
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}